<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>KOPASMEN - Tambah Pinjaman</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/phosphor-icons"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Flatpickr (AdminLTE style datepicker) -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

{% load widget_tweaks %}

<style>
    * {
        font-family: 'Poppins', sans-serif;
        box-sizing: border-box;
    }

    body {
        background: #f5f5f5;
        margin: 0;
        display: flex;
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background: linear-gradient(180deg, #FFD700 0%, #FFF8DC 100%);
        padding: 20px 0;
        position: fixed;
        height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    /* Main content */
    .main-content {
        margin-left: 280px;
        padding: 30px;
        flex: 1;
    }

    .form-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.08);
    }

    h2 {
        font-weight: 600;
        margin-bottom: 25px;
        color: #4A2C2A;
    }

    label {
        font-weight: 500;
        color: #4A2C2A;
        margin-bottom: 6px;
        display: block;
        font-size: 14px;
    }

    .form-control, 
    .select2-container--default .select2-selection--single {
        border-radius: 8px;
        font-size: 14px;
        padding: 8px 12px;
    }

    /* Rapiin dropdown select2 */
    .select2-container--default .select2-selection--single {
        height: 40px !important;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        background-color: #fff;
    }

    .select2-selection__arrow {
        top: 7px !important;
        right: 10px !important;
    }

    /* Flatpickr (tampilan mirip AdminLTE) */
    .flatpickr-calendar {
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        font-family: 'Poppins', sans-serif;
    }

    .flatpickr-day {
        border-radius: 6px;
    }

    .flatpickr-day.selected {
        background: #FFD700;
        border-color: #FFD700;
        color: #4A2C2A;
    }

    .flatpickr-day:hover {
        background: #fff3cd;
    }

    select.form-control {
        appearance: none;
        background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='gray' class='bi bi-caret-down-fill' viewBox='0 0 16 16'><path d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.658l-4.796 5.482a1 1 0 0 1-1.506 0z'/></svg>") no-repeat right 12px center;
        background-color: #fff;
        padding-right: 35px;
    }

    /* Tombol */
    .btn-tambah {
        background: #FFD700; 
        color: #4A2C2A; 
        font-weight: 600;
        padding: 6px 10px; 
        border-radius: 6px; 
        text-decoration: none;
        display: inline-flex; 
        align-items: center; 
        gap: 4px;
        font-size: 13px; 
        transition: 0.2s;
    }

    .btn-tambah:hover {
        background: #e6c200;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid #ccc;
        color: #4A2C2A;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s ease;
    }

    .btn-outline:hover {
        background: #fff9d4;
    }

    .alert {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        padding: 12px;
        margin-top: 20px;
        font-size: 14px;
        color: #856404;
    }
</style>
</head>

<body>
{% include "partials/sidebar.html" %}

<div class="main-content">
    <div class="form-card">
        <h2>Form Tambah Pinjaman</h2>
        <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_nomor_anggota">Nama Anggota</label>
                    <select id="id_nomor_anggota" name="nomor_anggota" class="form-control"></select>
                </div>
                <div class="col-md-6">
                    <label for="id_id_jenis_pinjaman">Jenis Pinjaman</label>
                    {{ form.id_jenis_pinjaman|add_class:"form-control"|attr:"data-placeholder:Pilih Jenis Pinjaman" }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Admin</label>
                    <input type="text" class="form-control" value="{{ username }}" disabled>
                    {{ form.id_admin }}
                </div>
                <div class="col-md-6">
                    <label for="id_tanggal_meminjam">Tanggal Pinjam</label>
                    {{ form.tanggal_meminjam|add_class:"form-control datepicker"|attr:"placeholder:Pilih tanggal pinjam"|attr:"autocomplete:off" }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_jatuh_tempo">Lama Pinjaman (bulan)</label>
                    {{ form.jatuh_tempo|add_class:"form-control" }}
                </div>
                <div class="col-md-6">
                    <label for="id_jumlah_pinjaman">Jumlah Pinjaman</label>
                    <input type="text" id="id_jumlah_pinjaman" name="jumlah_pinjaman"
                           class="form-control" maxlength="16" placeholder="Masukkan jumlah pinjaman" required>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_angsuran_per_bulan">Jumlah Cicilan</label>
                    {{ form.angsuran_per_bulan|add_class:"form-control" }}
                </div>
                <div class="col-md-6">
                    <label for="id_id_kategori_jasa">Kategori Jasa</label>
                    {{ form.id_kategori_jasa|add_class:"form-control" }}
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="id_jasa_persen">Persentase Jasa (%)</label>
                    <input type="number" id="id_jasa_persen" name="jasa_persen" class="form-control"
                           step="0.01" min="0" max="100" placeholder="Masukkan persen jasa" required>
                </div>
                <div class="col-md-6">
                    <label for="id_jasa_rupiah">Jumlah Jasa (Rp)</label>
                    <input type="text" id="id_jasa_rupiah" name="jasa_rupiah" class="form-control" readonly>
                </div>
            </div>

            <div class="text-end">
                <a href="{% url 'pinjaman_list' %}" class="btn btn-outline">Batal</a>
                <button type="submit" class="btn btn-tambah">
                    <i class="ph-bold ph-plus"></i> Tambah
                </button>
            </div>

            {% if form.errors %}
            <div class="alert mt-4">
                <ul class="mb-0">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// =======================
// FORMAT RIBUAN (TITIK)
// =======================
function formatRibuan(angka) {
    return angka.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// =======================
// SETUP INPUT RUPIAH
// =======================
function setupRupiahInput(id, callback = null) {
    const input = document.getElementById(id);
    if (!input) return;

    input.addEventListener('input', function () {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 16) value = value.slice(0, 16);
        this.value = formatRibuan(value);
        if (callback) callback();
    });
}

$(document).ready(function() {

    // Select2
    $('#id_nomor_anggota').select2({
        placeholder: "Cari anggota...",
        ajax: {
            url: "{% url 'anggota_search' %}",
            dataType: 'json',
            delay: 250,
            data: function(params) { return { q: params.term }; },
            processResults: function(data) { return { results: data.results }; },
            cache: true
        },
        minimumInputLength: 1,
        width: '100%'
    });

    // Flatpickr
    $(".datepicker").flatpickr({
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d F Y",
        locale: "id",
        allowInput: true
    });

    // ðŸ”¥ SEMUA INPUT NOMINAL PAKAI SATU FORMAT
    setupRupiahInput('id_jumlah_pinjaman', hitungJasa);
    setupRupiahInput('id_angsuran_per_bulan');
    setupRupiahInput('id_jasa_rupiah');

    // Hitung jasa
    $('#id_jasa_persen').on('input', hitungJasa);
});

// =======================
// HITUNG JASA
// =======================
function hitungJasa() {
    let jumlah = $('#id_jumlah_pinjaman').val().replace(/\./g, '');
    let persen = parseFloat($('#id_jasa_persen').val()) || 0;

    jumlah = parseInt(jumlah) || 0;

    if (jumlah > 0 && persen > 0) {
        let jasa = Math.round(jumlah * (persen / 100));
        $('#id_jasa_rupiah').val(formatRibuan(jasa.toString()));
    } else {
        $('#id_jasa_rupiah').val('');
    }
}

// =======================
// STRIP FORMAT SAAT SUBMIT
// =======================
$('form').on('submit', function() {
    ['id_jumlah_pinjaman', 'id_angsuran_per_bulan', 'id_jasa_rupiah'].forEach(function(id) {
        let el = $('#' + id);
        if (el.length) {
            el.val(el.val().replace(/\./g, ''));
        }
    });

    let jasaPersen = $('#id_jasa_persen').val();
    if (!/^\d+(\.\d{1,2})?$/.test(jasaPersen)) {
        alert("Pastikan persentase jasa tidak lebih dari 2 angka di belakang koma!");
        return false;
    }
});
</script>

</body>
</html>