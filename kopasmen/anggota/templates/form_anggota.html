{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>KOPASMEN - Form Anggota</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    * {
        font-family: 'Poppins', sans-serif;
        box-sizing: border-box;
    }

    body {
        background: #f5f5f5;
        margin: 0;
    }

    .main-content {
        margin-left: 280px;
        padding: 30px;
        min-height: 100vh;
        background: #f5f5f5;
    }

    .content-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }

    h1 { 
        margin-bottom: 20px; 
        color: #4A2C2A; 
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px 40px;
    }

    label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: #4A2C2A;
        font-size: 14px;
    }

    input.form-control, 
    select.form-control, 
    textarea.form-control {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        padding: 8px 12px;
        transition: 0.2s;
    }

    input:focus, select:focus, textarea:focus {
        border-color: #FFD700;
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.4);
        outline: none;
    }

    .form-actions {
        margin-top: 35px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }


    select.form-control {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        padding: 8px 12px;
        padding-right: 28px; /* space for icon */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: #fff url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="4"><polygon points="0,0 6,0 3,4" fill="%234A2C2A"/></svg>') no-repeat right 10px center;
        background-size: 6px 4px;
        cursor: pointer;
    }

    /* Tombol */
    .btn-simpan {
        background: #FFD700; 
        color: #4A2C2A; 
        font-weight: 600;
        padding: 6px 14px; 
        border-radius: 6px; 
        text-decoration: none;
        display: inline-flex; 
        align-items: center; 
        gap: 4px;
        font-size: 13px; 
        transition: 0.2s;
        border: none;
    }

    .btn-simpan:hover {
        background: #e6c200;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid #ccc;
        color: #4A2C2A;
        font-weight: 500;
        border-radius: 6px;
        padding: 6px 14px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s ease;
        text-decoration: none;
    }

    .btn-outline:hover {
        background: #fff9d4;
    }

    .error-msg { color: red; font-size: 13px; margin-top: 4px; }
    .success-msg { color: green; font-size: 13px; margin-top: 4px; }

    input.error { border-color: red !important; }
    input.success { border-color: green !important; }
</style>
</head>
<body>
    {% include "partials/sidebar.html" %}

    <div class="main-content">
        <div class="content-card">
            <h1>{{ judul }}</h1>
            <form method="post" id="anggotaForm">
                {% csrf_token %}
                <div class="form-grid">
                    {% for field in form %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            <div class="input-wrapper">
                                {{ field|add_class:"form-control" }}
                            </div>
                            {% if field.errors %}
                                <div class="error-msg">{{ field.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="form-actions">
                    <a href="{% url 'kelola_akun' %}" class="btn-outline">Batal</a>
                    <button type="submit" class="btn-simpan">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("anggotaForm");

            // === Validasi input ===
            function setStatus(input, message, status) {
                let msgEl = input.parentElement.querySelector(".msg");
                if (!msgEl) {
                    msgEl = document.createElement("div");
                    msgEl.classList.add("msg");
                    input.parentElement.appendChild(msgEl);
                }
                msgEl.textContent = message;
                msgEl.className = status === "error" ? "error-msg msg" : "success-msg msg";
                input.classList.remove("error", "success");
                input.classList.add(status);
            }

            function validateName(input) {
                if (input.value.length < 3) {
                    setStatus(input, "❌ Nama minimal 3 huruf.", "error");
                    return false;
                }
                setStatus(input, "✅ Nama sudah benar.", "success");
                return true;
            }

            function validateNIP(input) {
                if (!/^\d{8,20}$/.test(input.value)) {
                    setStatus(input, "❌ NIP harus berupa angka 8–20 digit.", "error");
                    return false;
                }
                setStatus(input, "✅ NIP valid.", "success");
                return true;
            }

            function validatePhone(input) {
                if (!/^\d{10,15}$/.test(input.value)) {
                    setStatus(input, "❌ Nomor telepon harus 10–15 digit angka.", "error");
                    return false;
                }
                setStatus(input, "✅ Nomor telepon valid.", "success");
                return true;
            }

            function validateEmail(input) {
                const email = input.value;
                const regex = /^[^@]+@[^@]+\.[^@]+$/;
                if (!regex.test(email)) {
                    setStatus(input, "❌ Format email tidak sesuai (contoh: contoh@gmail.com).", "error");
                    return false;
                }
                fetch(`/cek-email/?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.exists) {
                            setStatus(input, "❌ Email ini sudah dipakai, silakan gunakan yang lain.", "error");
                        } else {
                            setStatus(input, "✅ Email tersedia.", "success");
                        }
                    });
                return true;
            }

            const nama = form.querySelector("#id_nama");
            const nip = form.querySelector("#id_nip");
            const noTelp = form.querySelector("#id_no_telp");
            const email = form.querySelector("#id_email");

            if (nama) nama.addEventListener("input", () => validateName(nama));
            if (nip) nip.addEventListener("input", () => validateNIP(nip));
            if (noTelp) noTelp.addEventListener("input", () => validatePhone(noTelp));
            if (email) email.addEventListener("input", () => validateEmail(email));

            // === Tampilkan / sembunyikan field Nonaktif ===
            const statusSelect = document.getElementById("id_status");
            const alasanField = document.getElementById("id_alasan_nonaktif");
            const tanggalField = document.getElementById("id_tanggal_nonaktif");

            function toggleNonaktifFields() {
                if (!statusSelect) return;

                const isNonaktif = statusSelect.value.trim().toLowerCase() === "nonaktif";
                const alasanWrapper = alasanField.closest(".form-group");
                const tanggalWrapper = tanggalField.closest(".form-group");

                if (isNonaktif) {
                    alasanWrapper.style.display = "block";
                    tanggalWrapper.style.display = "block";
                } else {
                    alasanWrapper.style.display = "none";
                    tanggalWrapper.style.display = "none";
                    alasanField.value = "";
                    tanggalField.value = "";
                }
            }

            toggleNonaktifFields(); // pas load awal
            statusSelect.addEventListener("change", toggleNonaktifFields);
        });
        </script>

</body>
</html>
